# v1.0.0-rc.8: Multi-Timeframe Volume Trend Detection

**Release Date:** November 29, 2025

---

## Summary

RC8 introduces a sophisticated multi-timeframe moving average system that grows with data availability. The Volume Card now provides hierarchical trend signals from 100 minutes up to 7 days, enabling users to see both short-term volatility and long-term structural trends. The system is mathematically rigorous: each MA is only calculated when sufficient backing data exists.

### Key Features

- **Progressive MA Availability**: MAs appear in tooltip as soon as data window is complete
- **Accurate Data Gating**: No fake "3-day MA" with only 1 day of data
- **Hierarchical Trend Detection**: 7d > 3d > 1d > short (by priority)
- **Enhanced Tooltips**: Display all available MAs dynamically

---

## Changes

### Backend (`compute_taostats_aggregates.py`)

**New Multi-Timeframe Architecture:**

```
100min MA:  Always (first 3 samples)
1-day MA:   Always (first 10 samples)
3-day MA:   When N >= 432 (≥3 days of data)
7-day MA:   When N >= 1008 (≥7 days of data)
```

**Trend Direction Hierarchy:**
- **Level 1 (Highest Priority)**: 7-day MA ≤ -3% or ≥ +3% → DOWN/UP
- **Level 2**: 3-day MA ≤ -3% or ≥ +3% → DOWN/UP
- **Level 3**: 1-day MA ≤ -3% or ≥ +3% → DOWN/UP
- **Level 4 (Fallback)**: Short ≤ -3% AND med ≤ -1% → DOWN/UP

**Data Gating Logic:**
- 3-day MA: `None` until N ≥ 432 (prevents false calculations)
- 7-day MA: `None` until N ≥ 1008 (ensures full 7-day window)

### Frontend (`assets/taostats/taostats-card.js`)

**Smart Tooltip Building:**
```javascript
Δ vs MA (100min): -0.20%
Δ vs MA (1day): -2.35%
Δ vs MA (3day): -8.75%    ← Added only when available
Δ vs MA (7day): —          ← Added only when available
confidence: low
```

**Progressive Enhancement:**
- Shows what exists now
- Grows with data accumulation
- No placeholder lines for missing MAs

---

## Use Cases

### Current (1 Day of Data)
```
Tooltip shows:
- Δ vs MA (100min): -0.20%
- Δ vs MA (1day): -2.35%
- confidence: low

User sees: Short-term volatility + 1-day trend
```

### After 3 Days
```
Tooltip shows:
- Δ vs MA (100min): -0.20%
- Δ vs MA (1day): -2.35%
- Δ vs MA (3day): -8.75%    [NEW]
- confidence: medium

User sees: Plus the 3-day structural trend
```

### After 7 Days
```
Tooltip shows:
- Δ vs MA (100min): -0.20%
- Δ vs MA (1day): -2.35%
- Δ vs MA (3day): -8.75%
- Δ vs MA (7day): +1.23%    [NEW]
- confidence: high

User sees: Full 4-layer trend picture
```

---

## Testing Performed

✅ All test scenarios passing:

| N | Time | 3d MA | 7d MA | Reason |
|---|------|-------|-------|--------|
| 28 | 4.7h | ✗ | ✗ | Not enough data |
| 144 | 1d | ✗ | ✗ | Can't calculate 3-day from 1 day |
| 432 | 3d | ✓ | ✗ | 3d available, 7d needs more |
| 1008 | 7d | ✓ | ✓ | Both available |

✅ Tooltip rendering: Displays only available MAs, omits missing ones
✅ Trend detection: Hierarchy works as designed (7d > 3d > 1d > short)
✅ Backward compatibility: API still includes all fields (null when not available)

---

## Technical Details

### Data Window Mapping

```
Samples  Time      Available
28       4.7h      100min, 1day
144      1 day     100min, 1day
288      2 days    100min, 1day
432      3 days    100min, 1day, 3day
720      5 days    100min, 1day, 3day
1008     7 days    100min, 1day, 3day, 7day
```

### Algorithm: Hierarchical Evaluation

```python
if 7d exists and (7d <= -3% OR 7d >= +3%):
    trend = DOWN/UP
elif 3d exists and (3d <= -3% OR 3d >= +3%):
    trend = DOWN/UP
elif 1d <= -3% OR 1d >= +3%:
    trend = DOWN/UP
elif short <= -3% AND med <= -1%:
    trend = DOWN
else:
    trend = NEUTRAL
```

---

## Migration Notes

### For Users
- No action required; system evolves automatically
- Tooltip will show more information after 3 days
- Even more detail after 7 days
- Red/Green alerts follow the same hierarchy

### For Developers
- All MA fields in API response (some may be `null`)
- Frontend safely handles `null` values
- Can extend to longer timeframes (14d, 30d) easily
- Same gating logic applies: need full data window

---

## Known Limitations & Future Work

1. **Max Data Window**: Currently keeps ~10,000 samples = ~70 days (can be extended)
2. **Configurable Thresholds**: ±3% hardcoded, could become environment variables
3. **Volume Spikes**: Could flag extreme outliers as separate "anomaly" category
4. **Spark Chart**: Still planned for RC9 (click on card for 7-day chart)

---

## Deployment

**Immediate:**
1. Redeploy Worker or re-run `compute_taostats_aggregates.py`
2. Next aggregation job computes 3d/7d MAs
3. Frontend automatically shows new MAs in tooltip

**No Worker redeploy needed** for JS changes (static hosting).

---

## Example API Response (Current State)

```json
{
  "count": 28,
  "pct_change_vs_ma_short": -0.0020,
  "pct_change_vs_ma_med": -0.0235,
  "pct_change_vs_ma_3d": null,
  "pct_change_vs_ma_7d": null,
  "ma_short": 76001442.72,
  "ma_med": 77673681.99,
  "ma_3d": null,
  "ma_7d": null,
  "trend_direction": "down",
  "confidence": "low"
}
```

After 3 days:
```json
{
  "count": 432,
  "pct_change_vs_ma_short": 0.0012,
  "pct_change_vs_ma_med": -0.0150,
  "pct_change_vs_ma_3d": -0.0875,
  "pct_change_vs_ma_7d": null,
  "ma_short": 75234567.89,
  "ma_med": 76543210.12,
  "ma_3d": 83117658.04,
  "ma_7d": null,
  "trend_direction": "down",
  "confidence": "medium"
}
```

---

## Changelog

### Added
- 3-day moving average with ±3% threshold for independent alerts
- 7-day moving average with ±3% threshold for independent alerts
- Hierarchical trend priority: 7d > 3d > 1d > short-term
- Progressive MA display in tooltip (appears when data available)

### Changed
- Trend direction logic now evaluates timeframes in priority order
- MA fields return `null` instead of being omitted when data insufficient
- Tooltip now conditionally displays all available MAs

### Fixed
- Prevented misleading "3-day MA" calculations with insufficient data
- Eliminated false long-term trend signals from limited datasets
- Improved tooltip clarity with accurate data availability

---

## Feedback & Iteration

This release is data-driven: as your history grows, the system automatically reveals longer-term trends. Feedback welcome as you collect 3-day and 7-day data windows.

**Timeline**: After halving event, plan v1.0.0 final with spark chart visualization.
