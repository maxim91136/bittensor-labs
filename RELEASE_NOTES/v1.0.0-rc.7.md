# v1.0.0-rc.7: Volume Trend Seismograph Calibration

**Release Date:** November 29, 2025

---

## Summary

RC7 refines the Volume Card alert system with intelligent dual-MA confirmation logic and improved confidence calibration. The system now acts as a true **trend seismograph**: filtering short-term noise while remaining responsive to genuine volume shifts.

### Key Improvements

- **Dual-MA Confirmation**: Both short-term (100 min) and medium-term (1 day) moving averages must agree to trigger RED/GREEN alerts, eliminating false whiplash signals
- **Refined Thresholds**: ±3% short-term + ±1% medium-term ensures only meaningful trends are highlighted
- **Realistic Confidence Tiers**: Confidence now reflects actual data window (Low <1d, Medium 1-3d, High ≥3d), not just sample count
- **Enhanced Tooltips**: Displays both MA values + confidence level, giving users full visibility into why a card is RED/GREEN/neutral
- **Backend-Driven Styling**: Frontend now consumes `trend_direction` from backend, eliminating duplicate logic

---

## Changes

### Backend (`compute_taostats_aggregates.py`)

**Confidence Recalibration:**
- `Low`: <144 samples (~1 day)
- `Medium`: 144-432 samples (~1-3 days)
- `High`: ≥432 samples (~3 days)

**Trend Direction Logic (New):**
```
UP:   pct_vs_ma_short ≥ +3% AND pct_vs_ma_med ≥ +1%
DOWN: pct_vs_ma_short ≤ -3% AND pct_vs_ma_med ≤ -1%
Otherwise: NEUTRAL
```

**Rationale:**
- Short-term threshold (±3%) filters intraday noise, typical volume variance
- Medium-term threshold (±1%) confirms the short-term move is a genuine trend, not a blip
- Both must agree → fewer false positives, more predictable alerts

### Frontend (`assets/taostats/taostats-card.js`)

- Removed sign-based logic (was creating false positives on tiny changes)
- Now consumes `trend_direction` from API response
- Tooltip now shows: `Δ vs MA (100min)`, `Δ vs MA (1day)`, `confidence`
- Users can see exactly why a card is RED/GREEN

### Example Tooltips

```
Δ vs MA (100min): -3.5%
Δ vs MA (1day): -1.5%
confidence: medium
```

```
Δ vs MA (100min): +4.0%
Δ vs MA (1day): -0.5%
confidence: high
→ Result: NEUTRAL (disagreement → not a real trend)
```

---

## Testing Performed

✓ Confidence calculation: correct date-window mapping
✓ Trend detection: dual-MA confirmation filters noise
✓ Edge cases: exact threshold values, disagreement scenarios
✓ Backward compatibility: API response includes all fields

### Test Scenarios

| Scenario | N | pct_short | pct_med | Expected | Result |
|----------|---|-----------|---------|----------|--------|
| Fresh data, small dip | 50 | -1.5% | +0.2% | neutral | ✓ |
| 1 day, real downturn | 144 | -3.5% | -1.5% | down | ✓ |
| 3 days, strong upturn | 432 | +4.5% | +2.5% | up | ✓ |
| 3 days, disagreement | 432 | +4.0% | -0.5% | neutral | ✓ |

---

## Migration Notes

### For Users
- No action required; system will start showing smarter alerts
- Tooltip reveals confidence level and both MA values
- Fewer false positives (fewer color flashing)

### For Developers
- `trend_direction` field is now authoritative on the backend
- Frontend should NOT override with local logic
- Consider `confidence` level when consuming `trend_direction` in other features

---

## Known Limitations & Future Work

1. **Spark Chart** (deferred to RC8): Click on Volume Card to see 7-day trend chart
2. **Configurable Thresholds**: Currently hardcoded; could become environment variables
3. **Alternative MAs**: Could add 3-day, 7-day MAs for more granular control
4. **Volume Anomaly Detection**: Could flag unusual spikes as separate "anomaly" category

---

## Deployment

**Cloudflare Workers:**
- Redeploy Worker to pick up new aggregation logic
- Or: Schedule `compute_taostats_aggregates.py` via GitHub Actions

**Frontend:**
- No Worker redeploy needed for JS changes (static hosting)
- Browser cache: consider version bump in script tags if needed

---

## Feedback & Rollback

If alerts are still too sensitive or too conservative:
1. Adjust `short_threshold` (currently 0.03) in `compute_taostats_aggregates.py`
2. Adjust `med_threshold` (currently 0.01)
3. Redeploy and rerun aggregation script

Rollback: revert to RC6 by checking out git tag `v1.0.0-rc.6`

---

## Special Thanks

Community feedback on RC6 highlighted the "whiplash" problem. This release directly addresses that with a more intelligent trend detection engine.
