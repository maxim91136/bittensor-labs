name: Fetch and Push ATH/ATL from Coingecko to Cloudflare KV
on:
  workflow_dispatch:
  schedule:
  - cron: '0 */3 * * *' # Every 3 hours
jobs:
  fetch-ath-atl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install requests
      - name: Fetch ATH/ATL data
        run: python .github/scripts/fetch_ath_atl.py

      - name: Validate generated ATH/ATL JSON
        run: |
          if [ ! -f tao_ath_atl.json ]; then
            echo "No tao_ath_atl.json found"
            exit 1
          fi
          # Ensure required fields are present and numeric
          ATH=$(jq -r '.ath // empty' tao_ath_atl.json)
          ATL=$(jq -r '.atl // empty' tao_ath_atl.json)
          if [ -z "$ATH" ] || [ -z "$ATL" ]; then
            echo "Validation failed: 'ath' or 'atl' missing"
            jq . tao_ath_atl.json || true
            exit 2
          fi
          echo "Validation passed: ath=$ATH atl=$ATL"

      # R2 upload removed: no R2 bucket configured in this repo/account

      - name: Push ATH/ATL data to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
        run: |
          # Only write to KV if the file validates (previous step exits non-zero otherwise)
          URL="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/tao_ath_atl"
          echo "Writing tao_ath_atl.json to Cloudflare KV"
          curl -fsSL -X PUT \
            "$URL" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @tao_ath_atl.json
