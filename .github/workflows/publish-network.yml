name: Fetch Network Data

on:
  schedule:
    - cron: '7,22,37,52 * * * *' # every 15 Minuten, versetzt
  workflow_dispatch:
    inputs:
      replace_history:
        description: 'Replace issuance history (skip merge with KV data)'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install bittensor

      - name: Generate metrics
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          FORCE_ISSUANCE_ON_KV_FAIL: '0'
        run: |
          python .github/scripts/fetch_network.py

      - name: Push network metrics to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
        run: |
          bash .github/scripts/push_network_metrics.sh

      - name: Push issuance_history to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          FORCE_ISSUANCE_ON_KV_FAIL: '0'
          REPLACE_ISSUANCE_HISTORY: ${{ inputs.replace_history && '1' || '0' }}
        run: |
          bash .github/scripts/push_issuance_history.sh

      - name: Push Network history to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
        run: |
          if [ ! -f network_latest.json ]; then
            echo "No network_latest.json found - skipping network history"
            exit 0
          fi
          
          # Merge network_latest with existing history from KV
          python .github/scripts/merge-network-history.py
          
          # Check if merge was successful
          if [ ! -f /tmp/network_history_merged.json ]; then
            echo "❌ Failed to create merged history file"
            exit 1
          fi
          
          # Push merged history to KV
          KV_URL="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/network_history"
          CURL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X PUT "$KV_URL" -H "Authorization: Bearer ${CF_API_TOKEN}" -H "Content-Type: application/json" --data-binary @/tmp/network_history_merged.json || true)
          
          if [ "$CURL_STATUS" -ne 200 ] && [ "$CURL_STATUS" -ne 204 ]; then
            echo "❌ Failed to write network_history to KV (status=$CURL_STATUS)"
            exit 1
          fi
          echo "✅ Network history pushed to KV"

