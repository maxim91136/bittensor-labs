name: Fetch and Push X Alerts to Cloudflare KV

on:
  schedule:
    - cron: '*/15 * * * *' # every 15 minutes
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      MIN_FETCH_AGE_SECONDS: 900
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup node (used by other steps)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Ensure X API secrets are configured
        run: |
          if [ -z "${{ secrets.X_BEARER_TOKEN }}" ] || [ -z "${{ secrets.X_USER_ID }}" ]; then
            echo "Missing X_BEARER_TOKEN or X_USER_ID in repo secrets"
            exit 1
          fi

      - name: Fetch last since_id from Cloudflare KV
        id: get_since
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
        run: |
          if [ -z "${{ secrets.CF_API_TOKEN }}" ] || [ -z "${{ secrets.CF_ACCOUNT_ID }}" ] || [ -z "${{ secrets.CF_METRICS_NAMESPACE_ID }}" ]; then
            echo "since_id=" >> $GITHUB_OUTPUT
            echo "fetched_at=" >> $GITHUB_OUTPUT
            exit 0
          fi
          VAL=$(curl -fsSL -H "Authorization: Bearer ${CF_API_TOKEN}" "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/x_alerts_latest" || true)
          if [ -z "$VAL" ]; then
            echo "since_id=" >> $GITHUB_OUTPUT
            echo "fetched_at=" >> $GITHUB_OUTPUT
            exit 0
          fi
          SINCE=$(echo "$VAL" | jq -r '.alerts[0].id // empty')
          FETCHED_AT=$(echo "$VAL" | jq -r '.fetched_at // empty')
          echo "since_id=$SINCE" >> $GITHUB_OUTPUT
          echo "fetched_at=$FETCHED_AT" >> $GITHUB_OUTPUT

      - name: Skip fetch if last update recent
        id: skip_check
        run: |
          fetched_at="${{ steps.get_since.outputs.fetched_at }}"
          MIN_AGE=${{ env.MIN_FETCH_AGE_SECONDS }}
          if [ -z "$fetched_at" ]; then
            echo "skip_fetch=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          # compute age seconds using GNU date (UTC)
          AGE=-1
          if command -v date >/dev/null 2>&1; then
            # Try to parse ISO8601 timestamp and compute delta in seconds
            TS=$(date -u -d "$fetched_at" +%s 2>/dev/null || true)
            if [ -n "$TS" ]; then
              NOW=$(date -u +%s)
              AGE=$((NOW - TS))
            fi
          fi
          if [ "$AGE" -lt 0 ]; then
            # invalid timestamp, do not skip
            echo "skip_fetch=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ "$AGE" -lt "$MIN_AGE" ]; then
            echo "skip_fetch=true" >> $GITHUB_OUTPUT
          else
            echo "skip_fetch=false" >> $GITHUB_OUTPUT
          fi

      - name: Fetch alerts from X (Twitter)
        if: ${{ steps.skip_check.outputs.skip_fetch != 'true' }}
        id: fetch
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_USER_ID: ${{ secrets.X_USER_ID }}
          RETRY_ATTEMPTS: 3
          RETRY_BACKOFF: 2
          ALERTS_MAX: 5
          SINCE_ID: ${{ steps.get_since.outputs.since_id }}
        run: |
          mkdir -p data
          python -m pip install --upgrade pip && python -m pip install requests || true
          python .github/scripts/fetch_x_alerts.py -o x_alerts_latest.json -m 5 --since "$SINCE_ID"
          if [ ! -f x_alerts_latest.json ]; then
            echo "alerts.json not created"
            exit 1
          fi
          cat x_alerts_latest.json

      - name: Determine if Cloudflare KV is configured
        id: cf
        run: |
          enabled=false
          if [ -n "${{ secrets.CF_API_TOKEN }}" ] && [ -n "${{ secrets.CF_ACCOUNT_ID }}" ] && [ -n "${{ secrets.CF_METRICS_NAMESPACE_ID }}" ]; then
            enabled=true
          fi
          echo "enabled=${enabled}" >> $GITHUB_OUTPUT

      - name: Check whether fetch was skipped due to rate limits
        id: check_skipped
        run: |
          if [ -f x_alerts_latest.json ]; then
            if jq -e '._skipped == true' x_alerts_latest.json >/dev/null 2>&1; then
              echo "skipped=true" >> $GITHUB_OUTPUT
            else
              echo "skipped=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "skipped=true" >> $GITHUB_OUTPUT
          fi

      - name: Write to Cloudflare KV if configured
        if: ${{ steps.cf.outputs.enabled == 'true' && steps.check_skipped.outputs.skipped == 'false' }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
        run: |
          echo "Attempting to write to Cloudflare KV..."
          status=$(curl -s -o /dev/null -w "%{http_code}" -X PUT "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/x_alerts_latest" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @x_alerts_latest.json)
          echo "Cloudflare API HTTP Status: $status"
          if [ "$status" != "200" ] && [ "$status" != "204" ]; then
            echo "Cloudflare KV write failed with status $status";
            curl -v -X PUT "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/x_alerts_latest" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data-binary @x_alerts_latest.json || true
            exit 1
          fi
      - name: (Optional) show created file
        run: |
          ls -la x_alerts_latest.json || true
          echo "Done"
