name: Publish Bittensor metrics to Cloudflare KV
on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch: {}
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install bittensor
      - name: Generate metrics
        env:
          NETWORK: finney
        run: python .github/scripts/fetch_metrics.py
      - name: Build history array (last 24h)
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          HURL="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/history"
          curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" "$HURL" -o prev.json || echo "[]" > prev.json
          python - <<'PY'
          import json, time, sys
          try:
              m = json.load(open("metrics.json"))
          except Exception:
              sys.exit("no metrics.json")
          try:
              hist = json.load(open("prev.json"))
              if not isinstance(hist, list):
                  hist = []
          except Exception:
              hist = []
          point = {
              "t": m.get("updatedAtEpoch") or int(time.time()),
              "block": m.get("blockHeight"),
              "validators": m.get("validators"),
              "subnets": m.get("subnets"),
              "neurons": m.get("totalNeurons"),
          }
          hist.append(point)
          hist = hist[-144:]  # ~24h bei */10
          open("history.json","w").write(json.dumps(hist))
          PY
      - name: Push history to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          curl -fsS -X PUT \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @history.json \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/history"
      - name: Push to Cloudflare KV (debug)
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          URL="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/metrics"
          echo "PUT $URL"
          HTTP=$(curl -sS -o /tmp/body.json -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @metrics.json "$URL")
          echo "HTTP: $HTTP"
          echo "Response:"
          cat /tmp/body.json || true
          test "$HTTP" -ge 200 -a "$HTTP" -lt 300
      - name: Push subnets to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          curl -fsS -X PUT \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @subnets.json \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/subnets"
      - name: DEBUG subnets raw (SDK output)
        env:
          NETWORK: finney
        run: |
          python - <<'PY'
          import os, json, bittensor as bt
          net = os.getenv("NETWORK","finney")
          st = bt.subtensor(net)
          rows = []
          try:
              get_all = getattr(st, "get_all_subnets_info", None)
              if callable(get_all):
                  infos = get_all()
                  def to_dict(x):
                      # mÃ¶glichst viele Felder sichtbar machen
                      if hasattr(x, "__dict__"):
                          d = {k: (float(v) if isinstance(v,(int,float)) else v) for k,v in x.__dict__.items() if not k.startswith("_")}
                          return d
                      return {"repr": repr(x)}
                  rows = [to_dict(i) for i in infos]
              else:
                  # Fallback: netuids + get_subnet_info
                  netuids = getattr(st, "get_all_subnet_netuids", lambda: [])()
                  for uid in netuids[:20]:
                      try:
                          info = getattr(st, "get_subnet_info", lambda _u: None)(uid)
                          if info and hasattr(info,"__dict__"):
                              d = info.__dict__
                          else:
                              d = {"repr": repr(info)}
                          rows.append({"netuid": int(uid), **d})
                      except Exception as e:
                          rows.append({"netuid": int(uid), "error": str(e)})
          except Exception as e:
              rows = [{"error": f"collection failed: {e}"}]
          open("subnets-raw.json","w").write(json.dumps(rows[:50], indent=2, default=str))
          print("Sample:", json.dumps(rows[:3], indent=2, default=str))
          PY

      - uses: actions/upload-artifact@v4
        with:
          name: subnets-raw
          path: subnets-raw.json