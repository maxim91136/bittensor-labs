name: Publish Bittensor metrics to Cloudflare KV
on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch: {}
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install bittensor
      - name: Generate metrics
        env:
          NETWORK: finney
        run: python .github/scripts/fetch_metrics.py
      - name: Build history array (last 24h)
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          HURL="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/history"
          curl -sS -H "Authorization: Bearer ${CF_API_TOKEN}" "$HURL" -o prev.json || echo "[]" > prev.json
          python - <<'PY'
import json, time, sys
try:
  m = json.load(open("metrics.json"))
except Exception:
  sys.exit("no metrics.json")
try:
  hist = json.load(open("prev.json"))
  if not isinstance(hist, list): hist = []
except Exception:
  hist = []
point = {
  "t": m.get("updatedAtEpoch") or int(time.time()),
  "block": m.get("blockHeight"),
  "validators": m.get("validators"),
  "subnets": m.get("subnets"),
  "neurons": m.get("totalNeurons"),
}
hist.append(point)
hist = hist[-144:]  # ~24h bei */10
open("history.json","w").write(json.dumps(hist))
PY
      - name: Push history to Cloudflare KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          curl -fsS -X PUT \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @history.json \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/history"
      - name: Push to Cloudflare KV (debug)
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          URL="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/metrics"
          echo "PUT $URL"
          HTTP=$(curl -sS -o /tmp/body.json -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @metrics.json "$URL")
          echo "HTTP: $HTTP"
          echo "Response:"
          cat /tmp/body.json || true
          test "$HTTP" -ge 200 -a "$HTTP" -lt 300