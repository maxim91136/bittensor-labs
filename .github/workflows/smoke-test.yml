name: Smoke Test

on:
  push:
    tags:
      - 'v*'
      - 'v*-rc.*'
  workflow_dispatch:
    inputs:
      url:
        description: 'Network API URL to test (defaults to prod)'
        required: false
        default: 'https://bittensor-labs.com/api/network'
      skip_cloudflare_check:
        description: 'Allow Cloudflare challenge pages to be treated as OK (skips JSON validation)'
        required: false
        default: 'false'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health check - Network API
        run: |
          set -e
          URL="${{ github.event.inputs.url || 'https://bittensor-labs.com/api/network' }}"
          echo "Checking $URL"
          # Attempt with default UA; if challenge page is returned, try a browser UA fallback
          STATUS=$(curl -s -o /tmp/body -w "%{http_code}" -A "Mozilla/5.0 (X11; Linux x86_64)" "$URL" ) || true
          echo "HTTP status: $STATUS"
          BODY=$(cat /tmp/body | tr -d '\r')
          if [[ "$STATUS" != "200" ]]; then
            echo "Initial fetch returned $STATUS. Trying with browser UA..."
            STATUS=$(curl -s -o /tmp/body -w "%{http_code}" -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "$URL") || true
            BODY=$(cat /tmp/body | tr -d '\r')
            echo "Retry status: $STATUS"
          fi
          if [[ "$STATUS" == "200" ]]; then
            # If status is OK ensure it's not a challenge page
            if echo "$BODY" | grep -qi "Just a moment" || echo "$BODY" | grep -qi "Enable JavaScript and cookies"; then
              echo "â„¹ï¸  Found challenge page despite 200 status (Cloudflare)"; exit 0
            fi
            echo "ok" > /tmp/api_ok
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'dev-tests/package-lock.json'

      - name: Health check - Network API (Playwright fallback)
        if: always()
        run: |
          set -e
          if [ -f /tmp/api_ok ]; then
            echo "Skipping Playwright fallback â€” initial curl was successful"
            exit 0
          fi
          echo "Running Playwright fallback"
          URL="${{ github.event.inputs.url || 'https://bittensor-labs.com/api/network' }}"
          # Setup Node and Playwright (Node is configured by setup-node in previous step).
          # Use `npm ci` only if a lockfile exists for deterministic installs.
          pushd dev-tests
          echo "----- package.json -----"
          cat package.json || true
          echo "----- package-lock.json -----"
          if [ -f package-lock.json ]; then cat package-lock.json; else echo "(no lockfile)"; fi
          if [ -f package-lock.json ]; then
            echo "package-lock.json found: running npm ci (or falling back to npm install if it fails)"
            npm ci || npm install
          else
            echo "No lockfile found: running npm install"
            npm install
          fi
          # Attempt a lightweight rebuild to ensure native modules and scripts are ready
          npm rebuild || true
          # Debug versions and folders
          echo "node version: $(node -v)" || true
          echo "npm version: $(npm -v)" || true
          echo "List modules (top-level):"; ls -la node_modules || true
          echo "List bin directory (node_modules/.bin):"; ls -la node_modules/.bin || true
          # Ensure playwright-core is resolvable; if not, attempt to install playwright-core explicitly
          node -e "try{require('playwright-core'); console.log('playwright-core: ok'); process.exit(0);}catch(e){console.error('playwright-core missing'); process.exit(1);}" || (
            echo "Attempting explicit install of playwright-core and playwright..";
            npm install --no-audit --no-fund playwright-core playwright || true
          )
          # Show whether playwright CLI is available
          npx playwright --version || true
          # Try installing browsers and dependencies; try with deps first and add retries
          for i in 1 2 3; do
            npx playwright install --with-deps chromium && break || (
              echo "playwright install attempt $i failed, retrying...";
              sleep 3
            );
          done
          popd
          # Run the fetcher; output error if exit non-zero and dump diagnostics
          node dev-tests/playwright_fetch.js "$URL" || (
            echo "Playwright fetch failed; dumping diagnostics (npm ls, size of node_modules)...";
            npm ls --depth=0 || true;
            du -sh node_modules || true;
            true
          )
          if [ -f /tmp/playwright_body ]; then
            echo "Copying playwright_body to /tmp/body"
            cp /tmp/playwright_body /tmp/body
            echo "ok" > /tmp/api_ok
          fi

      - name: Validate Network API JSON
        if: always()
        run: |
          set -e
            SKIP_CF="${{ github.event.inputs.skip_cloudflare_check || 'false' }}"
            if [ ! -f /tmp/api_ok ]; then
              # If a body is present but indicates a Cloudflare challenge, either skip (if requested) or fail strictly
              if [ -f /tmp/body ] && (grep -qi "Just a moment" /tmp/body || grep -qi "Enable JavaScript and cookies" /tmp/body); then
                if [ "${SKIP_CF}" = "true" ]; then
                  echo "âš ï¸ Cloudflare challenge detected and skip enabled â€” skipping JSON validation"; exit 0
                fi
                echo "ðŸ›‘ Cloudflare challenge detected in body and skip disabled"; exit 1
              fi
              echo "No successful API fetch via curl or Playwright"; exit 1
            fi
          BODY=$(cat /tmp/body | tr -d '\r')
          # If the body is Cloudflare challenge page, fail with clear message
          if echo "$BODY" | grep -qi "Just a moment" || echo "$BODY" | grep -qi "Enable JavaScript and cookies"; then
            if [ "${SKIP_CF}" = "true" ]; then
              echo "âš ï¸ Cloudflare challenge detected in API response, skip enabled â€” passing."; exit 0
            fi
            echo "ðŸ›‘ Cloudflare challenge detected in API response"; exit 1
          fi
          # parse JSON if possible
          echo "$BODY" | jq . > /dev/null || (echo "ðŸ›‘ Invalid JSON"; exit 1)
          # Check required fields
          echo "$BODY" | jq -e '.halvingThresholds | length > 0' || (echo "ðŸ›‘ halvingThresholds missing"; exit 1)
          echo "$BODY" | jq -e '.totalIssuanceHuman != null' || (echo "ðŸ›‘ totalIssuanceHuman missing"; exit 1)

      - name: Health check - Frontend
        run: |
          set -e
          SITE_URL="https://bittensor-labs.com/"
          echo "Checking site root $SITE_URL"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL") || true
          if [ "$status" != "200" ]; then
            echo "ðŸ›‘ Site root returned non-200"; exit 1
          fi
      
