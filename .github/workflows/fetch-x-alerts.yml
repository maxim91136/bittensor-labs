name: Fetch X Alerts

on:
  schedule:
    - cron: '*/5 * * * *' # every 5 minutes
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup node (used by other steps)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Fetch alerts from X (Twitter)
        id: fetch
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_USER_ID: ${{ secrets.X_USER_ID }}
          ALERTS_MAX: 5
        run: |
          mkdir -p data
          python -m pip install --upgrade pip && python -m pip install requests || true
          python .github/scripts/fetch_x_alerts.py -o x_alerts_latest.json -m 5
          # ensure file exists
          if [ ! -f x_alerts_latest.json ]; then
            echo "alerts.json not created"
            exit 1
          fi
          cat x_alerts_latest.json

      - name: Determine if Cloudflare KV is configured
        id: cf
        run: |
          enabled=false
          if [ -n "${{ secrets.CF_API_TOKEN }}" ] && [ -n "${{ secrets.CF_ACCOUNT_ID }}" ] && [ -n "${{ secrets.CF_METRICS_NAMESPACE_ID }}" ]; then
            enabled=true
          fi
          echo "enabled=${enabled}" >> $GITHUB_OUTPUT

      - name: Write to Cloudflare KV if configured
        if: ${{ steps.cf.outputs.enabled == 'true' }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_METRICS_NAMESPACE_ID }}
        run: |
          echo "Attempting to write to Cloudflare KV..."
          status=$(curl -s -o /dev/null -w "%{http_code}" -X PUT "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/x_alerts_latest" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @x_alerts_latest.json)
          echo "Cloudflare API HTTP Status: $status"
          if [ "$status" != "200" ] && [ "$status" != "204" ]; then
            echo "Cloudflare KV write failed with status $status";
            curl -v -X PUT "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/x_alerts_latest" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data-binary @x_alerts_latest.json || true
            exit 1
          fi
      - name: (Optional) show created file
        run: |
          ls -la x_alerts_latest.json || true
          echo "Done"
